#!/usr/bin/env bash

set -e

export DEBIAN_FRONTEND=noninteractive

host_arch="$(host_arch.sh)"

apt-get update

if ! command -v snap; then
  apt install -y snapd
  systemctl enable --now snapd
  systemctl enable --now snapd.apparmor
fi

# https://www.kali.org/docs/general-use/metapackages/
apt install -y --install-recommends \
    build-essential \
    kali-defaults-desktop cool-retro-term \
    kali-tools-fuzzing kali-tools-crypto-stego kali-tools-database kali-tools-exploitation kali-tools-identify \
    kali-tools-information-gathering kali-tools-passwords kali-tools-post-exploitation kali-tools-vulnerability kali-tools-web kali-tools-windows-resources \
    "linux-headers-${host_arch}" zsh-autosuggestions zsh-syntax-highlighting zsh-theme-powerlevel9k jq htop code-oss golang-go neovim \
    seclists payloadsallthethings \
    gobuster hakrawler xxd file nikto wpscan joomscan nuclei whatweb hydra xsser python3-selenium feroxbuster \
      getsploit sploitscan vopono gowitness python3-dploot autorecon httprobe ghidra \
      flameshot gron zbar-tools \
    vim-gtk3 pipx \

apt autoremove -y

if command -v go; then
  test -f "${HOME}/go/bin/interactsh-client" || su vagrant -c "go install -v github.com/projectdiscovery/interactsh/cmd/interactsh-client@latest"
  test -f "${HOME}/go/bin/katana" || su vagrant -c "go install github.com/projectdiscovery/katana/cmd/katana@latest"
  test -f "${HOME}/go/bin/meg" || su vagrant -c "go install github.com/tomnomnom/meg@latest"
  test -f "${HOME}/go/bin/anew" || su vagrant -c "go install github.com/tomnomnom/anew@latest"
  test -f "${HOME}/go/bin/unfurl" || su vagrant -c "go install github.com/tomnomnom/unfurl@latest"
  test -f "${HOME}/go/bin/gf" || su vagrant -c "go install github.com/tomnomnom/gf@latest"
  test -f "${HOME}/go/bin/gau" || su vagrant -c "go install github.com/lc/gau/v2/cmd/gau@latest"
  test -f "${HOME}/go/bin/fabric" || su vagrant -c "go install github.com/danielmiessler/fabric@latest"
  test -f "${HOME}/go/bin/403jump" || su vagrant -c "go install github.com/trap-bytes/403jump@latest"
  test -f "${HOME}/go/bin/waybackurls" || su vagrant -c "go install github.com/tomnomnom/waybackurls@latest"
  test -f "${HOME}/go/bin/httpx" || su vagrant -c "go install github.com/projectdiscovery/httpx/cmd/httpx@latest"
fi

if ! test -f /usr/local/bin/shadycompass; then
  curl -L -o /usr/local/bin/shadycompass https://github.com/double16/shadycompass/releases/download/latest/shadycompass_main_linux_amd64
  chmod 0755 /usr/local/bin/shadycompass
fi

command -v llm || pipx install --global llm
