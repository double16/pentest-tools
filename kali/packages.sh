#!/usr/bin/env bash

set -e

export DEBIAN_FRONTEND=noninteractive

host_arch="$(host_arch.sh)"

reg_user="${SUDO_USER}"
reg_home="/home/${SUDO_USER}"
if [ -z "${reg_user}" ]; then
  reg_user="${USER}"
  reg_home="${HOME}"
fi

apt-get update

if ! command -v snap; then
  apt install -y snapd
  systemctl enable --now snapd
  systemctl enable --now snapd.apparmor
fi

ALL_SNAPS=""
ALL_PKGS="build-essential linux-headers-${host_arch} zsh-autosuggestions zsh-syntax-highlighting zsh-theme-powerlevel9k seclists payloadsallthethings jq htop code-oss golang-go neovim vim-gtk3 pipx cool-retro-term gobuster xxd file nikto  joomscan nuclei whatweb hydra xsser python3-selenium httprobe ghidra flameshot gron zbar-tools xclip python3-pwntools"

if grep -qi "kali" /etc/*release; then
# https://www.kali.org/docs/general-use/metapackages/
  ALL_PKGS="${ALL_PKGS} kali-defaults-desktop kali-tools-fuzzing kali-tools-crypto-stego kali-tools-database kali-tools-exploitation kali-tools-identify kali-tools-information-gathering kali-tools-passwords kali-tools-post-exploitation kali-tools-vulnerability kali-tools-web kali-tools-windows-resources"
  ALL_PKGS="${ALL_PKGS} wpscan feroxbuster vopono"
fi

if grep -qi "parrot" /etc/*release; then
  ALL_PKGS="${ALL_PKGS}"
  ALL_SNAPS="${ALL_SNAPS} feroxbuster"
fi

apt install -y --install-recommends ${ALL_PKGS}
      
apt autoremove -y

if [ -n "${ALL_SNAPS}" ]; then
  snap install ${ALL_SNAPS}
fi

if command -v go; then
  test -f "${reg_home}/go/bin/interactsh-client" || su ${reg_user} -c "go install -v github.com/projectdiscovery/interactsh/cmd/interactsh-client@latest"
  test -f "${reg_home}/go/bin/katana" || su ${reg_user} -c "go install github.com/projectdiscovery/katana/cmd/katana@latest"
  test -f "${reg_home}/go/bin/meg" || su ${reg_user} -c "go install github.com/tomnomnom/meg@latest"
  test -f "${reg_home}/go/bin/anew" || su ${reg_user} -c "go install github.com/tomnomnom/anew@latest"
  test -f "${reg_home}/go/bin/unfurl" || su ${reg_user} -c "go install github.com/tomnomnom/unfurl@latest"
  test -f "${reg_home}/go/bin/gf" || su ${reg_user} -c "go install github.com/tomnomnom/gf@latest"
  test -f "${reg_home}/go/bin/gau" || su ${reg_user} -c "go install github.com/lc/gau/v2/cmd/gau@latest"
  test -f "${reg_home}/go/bin/fabric" || su ${reg_user} -c "go install github.com/danielmiessler/fabric@latest"
  test -f "${reg_home}/go/bin/403jump" || su ${reg_user} -c "go install github.com/trap-bytes/403jump@latest"
  test -f "${reg_home}/go/bin/waybackurls" || su ${reg_user} -c "go install github.com/tomnomnom/waybackurls@latest"
  test -f "${reg_home}/go/bin/httpx" || su ${reg_user} -c "go install github.com/projectdiscovery/httpx/cmd/httpx@latest"
  test -f "${reg_home}/go/bin/gowitness" || su ${reg_user} -c "go install github.com/sensepost/gowitness@latest"
  test -f "${reg_home}/go/bin/hakrawler" || su ${reg_user} -c "go install github.com/hakluke/hakrawler@latest"
fi

if ! test -f /usr/local/bin/shadycompass; then
  curl -L -o /usr/local/bin/shadycompass https://github.com/double16/shadycompass/releases/download/latest/shadycompass_main_linux_amd64
  chmod 0755 /usr/local/bin/shadycompass
fi

if ! command -v pwndbg; then
  PWNDBG="https://github.com/pwndbg/pwndbg/releases/download/2024.08.29/pwndbg_2024.08.29_${host_arch}.deb"
  curl --fail -o /tmp/pwndbg.deb -L "${PWNDBG}"
  apt install -y /tmp/pwndbg.deb
  rm /tmp/pwndbg.deb
fi

for PKG in llm dploot getsploit sploitscan; do
  command -v ${PKG} || PIPX_BIN_DIR=/usr/local/bin pipx install ${PKG}
done
command -v autorecon || PIPX_BIN_DIR=/usr/local/bin pipx install git+https://github.com/Tib3rius/AutoRecon.git

