#!/bin/bash

set -x

TARGET_UID="$(stat --printf=%u /data)"
TARGET_GID="$(stat --printf=%g /data)"

if [[ ${TARGET_GID} -eq 0 ]]; then
  grep -qE "^kali:" /etc/group || adduser --quiet --group kali
  TARGET_GROUP="kali"
else
  grep -q ":${TARGET_GID}:" /etc/group || adduser --quiet --group --gid "${TARGET_GID}" kali
  TARGET_GROUP="$(id -gn -- ${TARGET_GID})"
fi

if [[ ${TARGET_UID} -eq 0 ]]; then
  grep -qE "^kali:" /etc/passwd || adduser --quiet --ingroup "${TARGET_GROUP}" --shell /bin/bash --disabled-password kali
  TARGET_USER="kali"
else
  grep -q ":${TARGET_UID}:" /etc/passwd || adduser --quiet --uid "${TARGET_UID}" --gid "${TARGET_GID}" --shell /bin/bash --disabled-password kali
  TARGET_USER="$(id -un -- ${TARGET_UID})"
fi

exec su "${TARGET_USER}" -c "while true; do sleep 3600; done"
