#!/bin/bash

set -x

# We need to open this for the adduser to populate the home dir
if [[ -d "/home/kali" ]]; then
  HOME_DIR="/tmp/home"
  rm -rf "${HOME_DIR}"
fi

TARGET_UID="$(stat --printf=%u /data)"
TARGET_GID="$(stat --printf=%g /data)"

if [[ ${TARGET_GID} -eq 0 ]]; then
  grep -qE "^kali:" /etc/group || adduser --quiet --group kali
  TARGET_GROUP="kali"
else
  grep -q ":${TARGET_GID}:" /etc/group || adduser --quiet --group --gid "${TARGET_GID}" kali
  TARGET_GROUP="$(id -gn -- ${TARGET_GID})"
fi

if [[ ${TARGET_UID} -eq 0 ]]; then
  grep -qE "^kali:" /etc/passwd || adduser --quiet --ingroup "${TARGET_GROUP}" --shell /usr/bin/zsh --disabled-password kali ${HOME_DIR:+--home "${HOME_DIR}"}
  TARGET_USER="kali"
else
  grep -q ":${TARGET_UID}:" /etc/passwd || adduser --quiet --uid "${TARGET_UID}" --gid "${TARGET_GID}" --shell /usr/bin/zsh --disabled-password kali ${HOME_DIR:+--home "${HOME_DIR}"}
  TARGET_USER="$(id -un -- ${TARGET_UID})"
fi

# fix perms on volume mount
if [[ -d "${HOME_DIR}" ]]; then
  rsync -a "${HOME_DIR}/" "/home/${TARGET_USER}/"
  chown -R "${TARGET_USER}:${TARGET_GROUP}" "/home/${TARGET_USER}"
  chmod 0750 "/home/${TARGET_USER}"
  rm -rf "${HOME_DIR}"
  usermod -d "/home/${TARGET_USER}" -m "${TARGET_USER}"
fi

echo "${TARGET_USER} ALL = NOPASSWD: ALL" >> /etc/sudoers.d/10_user
chmod 0440 /etc/sudoers.d/10_user

exec su "${TARGET_USER}" -c "while true; do sleep 3600; done"
