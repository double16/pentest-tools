# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.box = "kalilinux/rolling"
  config.vagrant.plugins = ["vagrant-cachier"]
  config.cache.scope = :box
  # config.vm.box_check_update = false
  # config.vm.network "forwarded_port", guest: 80, host: 8080
  # config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"
  # config.vm.network "private_network", ip: "192.168.33.10"
  # config.vm.network "public_network"
  # config.vm.synced_folder "../data", "/vagrant_data"

  config.vm.provision "shell", name: "config", privileged: false, inline: <<-SCRIPT
    gsettings set org.gnome.desktop.screensaver idle-activation-enabled false
  SCRIPT

  config.vm.provision "shell", name: "pia", privileged: false, inline: <<-SCRIPT
    [[ -f /usr/local/bin/piactl ]] && exit 0
    curl -L -o /tmp/pia.run https://installers.privateinternetaccess.com/download/pia-linux-3.3.1-06924.run
    bash /tmp/pia.run --quiet --accept
    rm /tmp/pia.run
  SCRIPT

  config.vm.provision "shell", name: "repos", privileged: false, inline: <<-SCRIPT
    mkdir -p /home/vagrant/src || exit $?
    cd /home/vagrant/src
    for URL in https://github.com/danielmiessler/SecLists.git https://github.com/fuzzdb-project/fuzzdb.git; do
      D="$(basename "${URL}" | sed 's/.git$//')"
      if [[ -d "${D}" ]]; then
        ( cd "${D}" && git pull --depth=1 )
      else
        git clone --depth 1 "${URL}"
      fi
    done
  SCRIPT

  config.vm.provision "shell", name: "packages", privileged: true, inline: <<-SCRIPT
    set -e
    if ! command -v snap; then
      apt install snapd
      systemctl enable snapd
      systemctl start snapd
    fi
    if [[ ! -f /snap/bin/obsidian ]]; then
      curl -o /tmp/obsidian.snap -L https://github.com/obsidianmd/obsidian-releases/releases/download/v0.15.6/obsidian_0.15.6_amd64.snap &&\
      snap install --dangerous /tmp/obsidian.snap
      rm /tmp/obsidian.snap
    fi

    apt install -y jq htop
    # Upgrading breaks things, like Chromium
    # apt upgrade -y burpsuite
  SCRIPT

  config.vm.provision "shell", name: "zap", privileged: false, inline: <<-SCRIPT
    sudo apt install -y zaproxy
    ZAP_ADDONINSTALL="zaproxy -cmd -addonupdate"
    for plugin in accessControl ascanrules ascanrulesBeta attacksurfacedetector sqliplugin directorylistv1 directorylistv2_3 bruteforce fuzzdb fuzzdboffensive graphql imagelocationscanner importurls jwt jsonview neonmarker oast openapi paramdigger pscanrulesBeta jython saml wappalyzer saverawmessage soap tokengen; do
      ZAP_ADDONINSTALL="${ZAP_ADDONINSTALL} -addoninstall ${plugin}"
    done
    echo ${ZAP_ADDONINSTALL}
    ${ZAP_ADDONINSTALL}
  SCRIPT

  config.vm.provider "virtualbox" do |vb|
    # Display the VirtualBox GUI when booting the machine
    vb.gui = true
    vb.linked_clone = true
    # vb.memory = "1024"
    # vb.cpus = 2
    # vb.customize ["modifyvm", :id, "--cpuexecutioncap", "50"]
  end

  config.vm.define "lululemon" do |v|
    v.provider "virtualbox" do |vb|
      vb.memory = "4096"
      vb.cpus = 4
    end
  end

  config.vm.define "pen100" do |v|
  end
end
