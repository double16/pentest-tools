# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  host_arch = RbConfig::CONFIG['host_cpu']
  if host_arch.include?('arm64') || host_arch.include?('aarch64')
    # VAGRANT_DEFAULT_PROVIDER=vmware_fusion or vmware_desktop
    config.vm.box = "mdiazn80/kali-arm64"
  else
    host_arch = "amd64"
    config.vm.box = "kalilinux/rolling"
  end

  config.vm.box_check_update = false
  # config.vagrant.plugins = ["vagrant-disksize"]
  if Vagrant.has_plugin?("vagrant-disksize")
    config.disksize.size = '300GB'
  end
  config.vm.box_check_update = false
  # config.vm.network "forwarded_port", guest: 80, host: 8080
  # config.vm.network "forwarded_port", guest: 80, host: 8080, host_ip: "127.0.0.1"
  # config.vm.network "private_network", ip: "192.168.33.10"
  # config.vm.network "public_network"
  # config.vm.synced_folder "../data", "/vagrant_data"

  config.vm.provision "shell", name: "config", privileged: true, inline: <<-SCRIPT
    gsettings set org.gnome.desktop.screensaver idle-activation-enabled false
    ln -sf /usr/share/zoneinfo/US/Central /etc/localtime
    cp -u /vagrant/host_arch.sh /usr/local/bin
  SCRIPT

  config.vm.provision "shell", name: "profile", privileged: true, env: { 'DEBIAN_FRONTEND': 'noninteractive'}, inline: <<-SCRIPT
    cp -u /vagrant/container/kali/{llm-functions,local-bin}.sh /etc/profile.d/
  SCRIPT

  config.vm.provision "shell", name: "packages", path: "packages.sh", privileged: true
  config.vm.provision "shell", name: "google-chrome",
                      path: "google-chrome-install.sh",
                      privileged: true,
                      run: host_arch == 'amd64' ? "once" : "never"
  config.vm.provision "shell", name: "docker", path: "docker-install.sh", privileged: true, run: "never"
  config.vm.provision "shell", name: "repos", path: "repos.sh", privileged: false
  config.vm.provision "shell", name: "pia", path: "pia-install.sh", privileged: false
  config.vm.provision "shell", name: "obsidian", path: "obsidian-install.sh", privileged: false
  config.vm.provision "shell", name: "caido", path: "caido-install.sh", privileged: false
  config.vm.provision "shell", name: "zap", path: "zap-install.sh", privileged: false
  config.vm.provision "shell", name: "zap-clean",
                      # after: "zap",
                      privileged: true, run: "never",
                      path: "zap-install.sh", args: ["--clean"]

  config.vm.provision "shell", name: "autologin", privileged: true, inline: <<-SCRIPT
    if [[ "$(</etc/X11/default-display-manager)" =~ "lightdm" ]]; then
      sed -i -e 's/#autologin-guest\s*=.*/autologin-guest=false/' -e 's/#autologin-user\s*=.*/autologin-user=vagrant/' -e 's/#autologin-user-timeout\s*=.*/autologin-user-timeout=0/' /etc/lightdm/lightdm.conf
    elif [[ "$(</etc/X11/default-display-manager)" =~ "gdm" ]]; then
      sed -i -e 's/#\s*AutomaticLoginEnable\s*=.*/AutomaticLoginEnable=true/' -e 's/#\s*AutomaticLogin\s*=.*/AutomaticLogin=vagrant/' /etc/gdm3/daemon.conf
    fi
  SCRIPT

  config.vm.provision "shell", name: "lockscreen", privileged: true, inline: <<-SCRIPT
        mkdir -p "/home/vagrant/.config/xfce4/xfconf/xfce-perchannel-xml"
        cat > "/home/vagrant/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-power-manager.xml" << EOF
<?xml version="1.0" encoding="UTF-8"?>

<channel name="xfce4-power-manager" version="1.0">
  <property name="xfce4-power-manager" type="empty">
    <property name="power-button-action" type="empty"/>
    <property name="show-panel-label" type="empty"/>
    <property name="show-tray-icon" type="bool" value="false"/>
    <property name="lock-screen-suspend-hibernate" type="bool" value="false"/>
    <property name="dpms-enabled" type="bool" value="false"/>
    <property name="blank-on-battery" type="int" value="0"/>
    <property name="blank-on-ac" type="int" value="0"/>
    <property name="logind-handle-lid-switch" type="bool" value="false"/>
  </property>
</channel>
EOF
        cat > "/home/vagrant/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-screensaver.xml" << EOF
<?xml version="1.0" encoding="UTF-8"?>

<channel name="xfce4-screensaver" version="1.0">
  <property name="lock" type="empty">
    <property name="sleep-activation" type="bool" value="false"/>
  </property>
</channel>
EOF
  SCRIPT

  config.vm.provision "shell", name: "dropbox",
                      path: "dropbox-install.sh",
                      privileged: false,
                      run: "never"

  config.vm.provider "virtualbox" do |vb|
    # Display the VirtualBox GUI when booting the machine
    vb.gui = true
    # linked clones cannot increase disk space
    vb.linked_clone = false
    vb.memory = "12288"
    vb.cpus = 6
  end
  config.vm.provider "vmware_fusion" do |vb|
    # Display the VirtualBox GUI when booting the machine
    vb.gui = true
    # linked clones cannot increase disk space
    vb.linked_clone = false
    vb.memory = "12288"
    vb.cpus = 6
  end
  config.vm.provider "libvirt" do |libvirt|
    libvirt.memory = "12288"
    libvirt.cpus = 6
    libvirt.driver = "qemu"
    libvirt.features = ['apic', 'pae' ]
    libvirt.usb_controller :model => "qemu-xhci"
    libvirt.input :type => "tablet", :bus => "usb"
  end
end
