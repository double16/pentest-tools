#!/usr/bin/env bash

set +e

# TODO: config zap-excludes.txt

# Weekly releases on Monday
SAVE_TZ="${TZ}"
TZ="America/Chicago"
current_dow="$(date +%u)"
dow_offset=$((current_dow - 1))
if [ $dow_offset -lt 0 ]; then
  dow_offset=$((dow_offset + 7))
fi
if [ $dow_offset -lt 5 ]; then
  # go back one week to give time for publishing
  dow_offset=$((dow_offset + 7))
fi
last_monday="$(date --date="${dow_offset} days ago" +%Y-%m-%d)"
TZ="${SAVE_TZ}"

ZAP_WEEKLY="${last_monday}"
ZAP_WEEKLY_DIR="/usr/local/share/ZAP_D-${ZAP_WEEKLY}"

ZAP_PLUGINS="
accessControl
ascanrules
ascanrulesBeta
attacksurfacedetector
authstats
browserView
bruteforce
callgraph
client
communityScripts
custompayloads
directorylistv2_3
evalvillain
fileupload
fuzzdb
fuzzdboffensive
graphql
highlighter
imagelocationscanner
jsonview
jython
jwt
levoai
neonmarker
oast
openapi
packpentester
paramdigger
pscanrulesBeta
pscanrulesAlpha
reflect
reveal
revisit
saml
sequence
soap
sqliplugin
sse
svndigger
tokengen
treetools
viewstate
wappalyzer
webdriverlinux
zest
"

if [ "$1" == "--clean" ]; then
  find "/usr/local/share" -maxdepth 1 -name "ZAP_D-*" -not -name "*-${ZAP_WEEKLY}" -print0 | sudo xargs -r0 rm -rf
  sudo find /usr/share/applications /usr/share/kali-menu/applications -name "kali-zaproxy-*.desktop" -not -name "*-${ZAP_WEEKLY}.desktop" -delete
  exit 0
fi

# Find the assets directory
export ASSETS_DIR=
for D in $(df -x tmpfs | awk '{print $6}'; echo /vagrant; echo "${HOME}/Dropbox"); do
  if [[ -d "${D}/assets" ]]; then
    ASSETS_DIR="${D}/assets"
  elif [[ -d "${D}/Assessments/assets" ]]; then
    ASSETS_DIR="${D}/Assessments/assets"
  fi
done
if [[ -n "${ASSETS_DIR}" ]]; then
  echo "Found assets at ${ASSETS_DIR}"
else
  echo "No assets directory found"
fi

export ZAP_RELEASE_CONF=
if command -v zaproxy; then
  ZAP_RELEASE_CONF=.ZAP
else
  echo "zaproxy release not found, if you want to use it run:"
  echo "  sudo apt install -y zaproxy"
fi

ZAP_WEEKLY_URL="https://github.com/zaproxy/zaproxy/releases/download/w${ZAP_WEEKLY}/ZAP_WEEKLY_D-${ZAP_WEEKLY}.zip"
ZAP_WEEKLY_DIR="${ZAP_WEEKLY_DIR}"
ZAP_WEEKLY_BIN="/usr/local/share/ZAP_D-${ZAP_WEEKLY}/zap.sh"
ZAP_WEEKLY_DESKTOP="kali-zaproxy-${ZAP_WEEKLY}.desktop"
if [ ! -f "${ZAP_WEEKLY_BIN}" ]; then
  curl --fail -L -o /tmp/zap.zip "${ZAP_WEEKLY_URL}" || exit $?
  sudo unzip /tmp/zap.zip -d /usr/local/share
  test -f "${ZAP_WEEKLY_BIN}"
fi

sudo tee "/usr/share/applications/${ZAP_WEEKLY_DESKTOP}" << EOF
[Desktop Entry]
Name=zap ${ZAP_WEEKLY}
StartupWMClass=ZAP ${ZAP_WEEKLY}
Encoding=UTF-8
Exec=${ZAP_WEEKLY_BIN}
Icon=kali-zaproxy
StartupNotify=false
Terminal=false
Type=Application
Categories=03-webapp-analysis;
X-Kali-Package=zaproxy
EOF

if [ -d '/usr/share/kali-menu' ]; then
  sudo cp "/usr/share/applications/${ZAP_WEEKLY_DESKTOP}" "/usr/share/kali-menu/applications/${ZAP_WEEKLY_DESKTOP}"
fi

for ZAP_CONF in ${ZAP_RELEASE_CONF} .ZAP_D; do
  ZAP_DIR="${HOME}/${ZAP_CONF}"
  mkdir -p "${ZAP_DIR}"
  ZAP_JVM_FILE="${ZAP_DIR}/.ZAP_JVM.properties"
  if [ ! -s "${ZAP_JVM_FILE}" ]; then
    echo "-Xmx2G" > "${ZAP_JVM_FILE}"
  fi
  ZAP_CONFIG_FILE="${ZAP_DIR}/config.xml"
  if [ ! -s "${ZAP_CONFIG_FILE}" ] && [ -s "${ASSETS_DIR}/zap/config.xml" ]; then
    cp "${ASSETS_DIR}/zap/config.xml" "${ZAP_CONFIG_FILE}"
  fi
done

ZAP_ADDONINSTALL_ARGS="-cmd"
for plugin in ${ZAP_PLUGINS}; do
  ZAP_ADDONINSTALL_ARGS="${ZAP_ADDONINSTALL_ARGS} -addoninstall ${plugin}"
done

if command -v zaproxy; then
  echo zaproxy -cmd -addonupdate
  zaproxy -cmd -addonupdate
  echo zaproxy ${ZAP_ADDONINSTALL_ARGS}
  zaproxy ${ZAP_ADDONINSTALL_ARGS}
fi

echo ${ZAP_WEEKLY_BIN} -cmd -addonupdate
${ZAP_WEEKLY_BIN} -cmd -addonupdate
echo ${ZAP_WEEKLY_BIN} ${ZAP_ADDONINSTALL_ARGS}
${ZAP_WEEKLY_BIN} ${ZAP_ADDONINSTALL_ARGS}

[[ -n "${ZAP_RELEASE_CONF}" ]] && mkdir -p "${HOME}/${ZAP_RELEASE_CONF}/plugin"
mkdir -p "${HOME}/.ZAP_D/plugin"
if [[ -n "${ASSETS_DIR}" ]] && [[ -d "${ASSETS_DIR}/zap" ]]; then
  find "${ASSETS_DIR}/zap" -iname "*.zap" -type f 2>/dev/null | while read F; do
    [[ -n "${ZAP_RELEASE_CONF}" ]] && cp -uv "${F}" "${HOME}/${ZAP_RELEASE_CONF}/plugin/"
    cp -uv "${F}" "${HOME}/.ZAP_D/plugin/"
  done
fi

find "${HOME}/.config/xfce4/panel" -name "whiskermenu*.rc" -type f | while read F; do
  if ! grep -q "favorites=.*${ZAP_WEEKLY_DESKTOP}" "${F}"; then
    sed -e "s/favorites=.*/\\0,${ZAP_WEEKLY_DESKTOP}/" -i "${F}"
  fi
done
