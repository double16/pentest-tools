#!/usr/bin/env bash

# TODO: config zap-excludes.txt

ZAP_WEEKLY="2024-02-19"
ZAP_WEEKLY_DIR="/usr/local/share/ZAP_D-${ZAP_WEEKLY}"

ZAP_PLUGINS="
accessControl
ascanrules
ascanrulesBeta
attacksurfacedetector
authstats
browserView
bruteforce
callgraph
communityScripts
custompayloads
directorylistv2_3
evalvillain
fileupload
fuzzdb
fuzzdboffensive
graphql
highlighter
imagelocationscanner
jsonview
jython
jwt
levoai
neonmarker
oast
openapi
packpentester
paramdigger
pscanrulesBeta
reflect
reveal
revisit
saml
sequence
soap
sqliplugin
sse
tokengen
treetools
viewstate
wappalyzer
webdriverlinux
zest
"

if [ "$1" == "--clean" ]; then
  find "/usr/local/share" -maxdepth 1 -name "ZAP_D-*" -not -name "*-${ZAP_WEEKLY}" -print0 | sudo xargs -r0 rm -rf
  sudo find /usr/share/applications /usr/share/kali-menu/applications -name "kali-zaproxy-*.desktop" -not -name "*-${ZAP_WEEKLY}.desktop" -delete
  exit 0
fi

# Find the assets directory
export ASSETS_DIR=
for D in $(df -x tmpfs | awk '{print $6}'; echo /vagrant; echo "${HOME}/Dropbox"); do
  if [[ -d "${D}/assets" ]]; then
    ASSETS_DIR="${D}/assets"
  elif [[ -d "${D}/Assessments/assets" ]]; then
    ASSETS_DIR="${D}/Assessments/assets"
  fi
done
if [[ -n "${ASSETS_DIR}" ]]; then
  echo "Found assets at ${ASSETS_DIR}"
else
  echo "No assets directory found"
fi

command -v zaproxy || sudo apt install -y zaproxy

ZAP_WEEKLY="${ZAP_WEEKLY}"
ZAP_WEEKLY_URL="https://github.com/zaproxy/zaproxy/releases/download/w${ZAP_WEEKLY}/ZAP_WEEKLY_D-${ZAP_WEEKLY}.zip"
ZAP_WEEKLY_DIR="${ZAP_WEEKLY_DIR}"
ZAP_WEEKLY_BIN="/usr/local/share/ZAP_D-${ZAP_WEEKLY}/zap.sh"
ZAP_WEEKLY_DESKTOP="kali-zaproxy-${ZAP_WEEKLY}.desktop"
if [ ! -f "${ZAP_WEEKLY_BIN}" ]; then
  curl -L -o /tmp/zap.zip "${ZAP_WEEKLY_URL}"
  sudo unzip /tmp/zap.zip -d /usr/local/share
  test -f "${ZAP_WEEKLY_BIN}"
fi

sudo tee "/usr/share/applications/${ZAP_WEEKLY_DESKTOP}" << EOF
[Desktop Entry]
Name=zap ${ZAP_WEEKLY}
StartupWMClass=ZAP ${ZAP_WEEKLY}
Encoding=UTF-8
Exec=${ZAP_WEEKLY_BIN}
Icon=kali-zaproxy
StartupNotify=false
Terminal=false
Type=Application
Categories=03-webapp-analysis;
X-Kali-Package=zaproxy
EOF

if [ -d '/usr/share/kali-menu' ]; then
  sudo cp "/usr/share/applications/${ZAP_WEEKLY_DESKTOP}" "/usr/share/kali-menu/applications/${ZAP_WEEKLY_DESKTOP}"
fi

for ZAP_CONF in .ZAP .ZAP_D; do
  ZAP_DIR="${HOME}/${ZAP_CONF}"
  mkdir -p "${ZAP_DIR}"
  ZAP_JVM_FILE="${ZAP_DIR}/.ZAP_JVM.properties"
  if [ ! -s "${ZAP_JVM_FILE}" ]; then
    echo "-Xmx2G" > "${ZAP_JVM_FILE}"
  fi
  ZAP_CONFIG_FILE="${ZAP_DIR}/config.xml"
  if [ ! -s "${ZAP_CONFIG_FILE}" ] && [ -s "${ASSETS_DIR}/zap/config.xml" ]; then
    cp "${ASSETS_DIR}/zap/config.xml" "${ZAP_CONFIG_FILE}"
  fi
done

ZAP_ADDONINSTALL_ARGS="-cmd -addonupdate"
for plugin in ${ZAP_PLUGINS}; do
  ZAP_ADDONINSTALL_ARGS="${ZAP_ADDONINSTALL_ARGS} -addoninstall ${plugin}"
done

if command -v zaproxy; then
  echo zaproxy ${ZAP_ADDONINSTALL_ARGS}
  zaproxy ${ZAP_ADDONINSTALL_ARGS}
fi

echo ${ZAP_WEEKLY_BIN} ${ZAP_ADDONINSTALL_ARGS}
${ZAP_WEEKLY_BIN} ${ZAP_ADDONINSTALL_ARGS}

mkdir -p "${HOME}/.ZAP/plugin" "${HOME}/.ZAP_D/plugin"
if [[ -n "${ASSETS_DIR}" ]] && [[ -d "${ASSETS_DIR}/zap" ]]; then
  find "${ASSETS_DIR}/zap" -iname "*.zap" -type f 2>/dev/null | while read F; do
    cp -uv "${F}" "${HOME}/.ZAP/plugin/"
    cp -uv "${F}" "${HOME}/.ZAP_D/plugin/"
  done
fi

find "${HOME}/.config/xfce4/panel" -name "whiskermenu*.rc" -type f | while read F; do
  if ! grep -q "favorites=.*${ZAP_WEEKLY_DESKTOP}" "${F}"; then
    sed -e "s/favorites=.*/\\0,${ZAP_WEEKLY_DESKTOP}/" -i "${F}"
  fi
done
